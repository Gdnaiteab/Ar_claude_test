# ARé¢„æµ‹è§†é¢‘æ¨¡å‹é¡¹ç›®

åŸºäºTransformerçš„è‡ªå›å½’æ°”è±¡æ•°æ®é¢„æµ‹æ¨¡å‹ï¼Œç”¨äºé¢„æµ‹æœªæ¥æ—¶åˆ»çš„æ°”è±¡åœºæ•°æ®ã€‚

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®å®ç°äº†ä¸€ä¸ªåŸºäºVision Transformer (ViT) çš„è‡ªå›å½’é¢„æµ‹æ¨¡å‹ï¼Œèƒ½å¤Ÿé€šè¿‡è¿‡å»è‹¥å¹²æ—¶åˆ»çš„å¤šå˜é‡æ°”è±¡æ•°æ®ï¼Œé¢„æµ‹æœªæ¥æ—¶åˆ»çš„æ°”è±¡åœºåˆ†å¸ƒã€‚æ¨¡å‹é‡‡ç”¨patch-basedçš„tokenåŒ–æ–¹å¼ï¼Œç»“åˆæ—¶ç©ºåŒºå—åˆ’åˆ†å’Œè‡ªå›å½’æ©ç æœºåˆ¶ï¼Œå®ç°é«˜ç²¾åº¦çš„æ°”è±¡æ•°æ®é¢„æµ‹ã€‚

### ğŸ¯ ä¸»è¦ç‰¹æ€§

- **å¤šå˜é‡æ”¯æŒ**: æ”¯æŒ69ä¸ªæ°”è±¡å˜é‡ï¼ˆå•å±‚å’Œå¤šå±‚å˜é‡ï¼‰
- **æ—¶ç©ºå»ºæ¨¡**: é‡‡ç”¨ViT patch embedding + Transformeræ¶æ„
- **è‡ªå›å½’é¢„æµ‹**: æ”¯æŒå•æ­¥å’Œå¤šæ­¥é¢„æµ‹
- **çµæ´»é…ç½®**: åŸºäºYAMLçš„å®Œæ•´é…ç½®ç³»ç»Ÿ
- **å®éªŒè·Ÿè¸ª**: é›†æˆWandbè¿›è¡Œè®­ç»ƒç›‘æ§å’Œå¯è§†åŒ–
- **æ•°æ®å®Œæ•´æ€§**: è‡ªåŠ¨æ£€æµ‹å’Œæ’å€¼ç¼ºå¤±æ•°æ®
- **å¯è§†åŒ–**: å†…ç½®é¢„æµ‹ç»“æœå¯è§†åŒ–åŠŸèƒ½

## ğŸ“ é¡¹ç›®ç»“æ„

```
ar_claude_test/
â”œâ”€â”€ checkpoints/          # æ¨¡å‹æ£€æŸ¥ç‚¹å­˜å‚¨
â”œâ”€â”€ config/              # é…ç½®æ–‡ä»¶
â”‚   â””â”€â”€ ar_pred_video_vanilla.yaml
â”œâ”€â”€ log/                 # è®­ç»ƒæ—¥å¿—
â”œâ”€â”€ models/              # æ¨¡å‹æ¶æ„
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ ar_pred_video_vanilla.py
â”œâ”€â”€ tmp/                 # ä¸´æ—¶æ–‡ä»¶
â”œâ”€â”€ utils/               # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ config.py
â”‚   â”œâ”€â”€ dataloader.py
â”‚   â””â”€â”€ logger.py
â”œâ”€â”€ wandb/               # Wandbæ•°æ®
â”œâ”€â”€ train_ar_pred_video_vanilla.py    # è®­ç»ƒè„šæœ¬
â”œâ”€â”€ inference_ar_pred_video_vanilla.py # æ¨ç†è„šæœ¬
â”œâ”€â”€ setup_env.sh         # ç¯å¢ƒè®¾ç½®è„šæœ¬
â”œâ”€â”€ requirements.txt     # ä¾èµ–åŒ…
â”œâ”€â”€ .gitignore
â””â”€â”€ README.md
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒè®¾ç½®

```bash
# åˆ›å»ºcondaç¯å¢ƒ
./setup_env.sh

# æ¿€æ´»ç¯å¢ƒ
conda activate ar_pred

# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

### 2. æ•°æ®å‡†å¤‡

ç¡®ä¿æ‚¨çš„æ•°æ®æŒ‰ä»¥ä¸‹ç»“æ„ç»„ç»‡ï¼š

```
/sharefiles4/qubohuan/
â”œâ”€â”€ t2m_npy/             # 2ç±³æ¸©åº¦ï¼ˆå•å±‚ï¼‰
â”‚   â”œâ”€â”€ 1979/
â”‚   â”‚   â”œâ”€â”€ 1979-0000.npy
â”‚   â”‚   â”œâ”€â”€ 1979-0001.npy
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ mean_std.json
â”‚   â””â”€â”€ min_max.json
â”œâ”€â”€ r_npy/               # ç›¸å¯¹æ¹¿åº¦ï¼ˆ13å±‚ï¼‰
â”‚   â”œâ”€â”€ level_00/
â”‚   â”‚   â”œâ”€â”€ 1979/
â”‚   â”‚   â”œâ”€â”€ mean_std.json
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ ...
â””â”€â”€ ...
```

**æ•°æ®æ ¼å¼è¦æ±‚:**
- æ¯ä¸ª`.npy`æ–‡ä»¶å½¢çŠ¶: `(128, 256)`, ç±»å‹: `float32`
- æ•°æ®å·²ç»æ ‡å‡†åŒ–å¤„ç†
- `mean_std.json`åŒ…å«å‡å€¼å’Œæ ‡å‡†å·®ä¿¡æ¯

### 3. é…ç½®æ–‡ä»¶

ç¼–è¾‘ `config/ar_pred_video_vanilla.yaml` æ¥è°ƒæ•´æ¨¡å‹å’Œè®­ç»ƒå‚æ•°ï¼š

```yaml
# æ•°æ®é…ç½®
data:
  data_root: "/sharefiles4/qubohuan/"  # ä¿®æ”¹ä¸ºæ‚¨çš„æ•°æ®è·¯å¾„
  time_interval: 6                     # æ—¶é—´é—´éš”ï¼ˆå°æ—¶ï¼‰
  variables:                          # ä½¿ç”¨çš„å˜é‡é…ç½®
    single_level: ["t2m_npy", "tp_npy", "u10_npy", "v10_npy"]
    multi_level:
      - variable: "r_npy"
        levels: ["level_00"]

# æ¨¡å‹é…ç½®
model:
  time_window: 8                      # æ—¶é—´çª—å£å¤§å°
  patch_size: [16, 16]               # patchå¤§å°
  embed_dim: 768                     # åµŒå…¥ç»´åº¦
  
# è®­ç»ƒé…ç½®
training:
  num_epochs: 100
  learning_rate: 1e-4
  batch_size: 16
```

### 4. è®­ç»ƒæ¨¡å‹

```bash
# å¼€å§‹è®­ç»ƒ
python train_ar_pred_video_vanilla.py --config config/ar_pred_video_vanilla.yaml

# ä»æ£€æŸ¥ç‚¹æ¢å¤è®­ç»ƒ
python train_ar_pred_video_vanilla.py --config config/ar_pred_video_vanilla.yaml --resume checkpoints/latest_model.pth
```

### 5. æ¨¡å‹æ¨ç†

```bash
# å•æ­¥é¢„æµ‹
python inference_ar_pred_video_vanilla.py \
    --config config/ar_pred_video_vanilla.yaml \
    --checkpoint checkpoints/best_model.pth \
    --input_files file1.npy file2.npy ... \
    --output_dir tmp/inference_results \
    --visualize

# å¤šæ­¥é¢„æµ‹
python inference_ar_pred_video_vanilla.py \
    --config config/ar_pred_video_vanilla.yaml \
    --checkpoint checkpoints/best_model.pth \
    --input_files file1.npy file2.npy ... \
    --output_dir tmp/inference_results \
    --multi_step 5 \
    --use_true_data \
    --visualize
```

## ğŸ—ï¸ æ¨¡å‹æ¶æ„

### ARé¢„æµ‹è§†é¢‘Vanillaæ¨¡å‹

æ¨¡å‹é‡‡ç”¨ä»¥ä¸‹æ¶æ„è®¾è®¡ï¼š

1. **Patch Embedding**: å°†è¾“å…¥çš„æ—¶ç©ºæ•°æ®è½¬æ¢ä¸ºtokenåºåˆ—
   - è¾“å…¥: `(B, T, H, W, V)` â†’ é‡å¡‘ä¸º `(B, T*V, H, W)`
   - PatchåŒ–: `(B, num_patches*T, embed_dim)`

2. **ä½ç½®ç¼–ç **: ä¸ºæ¯ä¸ªpatchæ·»åŠ å¯å­¦ä¹ çš„ä½ç½®ç¼–ç 

3. **æ—¶ç©ºåŒºå—åˆ’åˆ†**: å°†tokensæŒ‰æ—¶é—´ç»´åº¦åˆ’åˆ†ä¸ºTä¸ªåŒºå—

4. **Random Patchify**: éšæœºç§»é™¤ä¸€ä¸ªåŒºå—ä½œä¸ºé¢„æµ‹ç›®æ ‡

5. **Transformer Encoder** (8å±‚):
   - å¤šå¤´è‡ªæ³¨æ„åŠ›ï¼ˆå¸¦è‡ªå›å½’æ©ç ï¼‰
   - MLP + æ®‹å·®è¿æ¥
   - LayerNorm

6. **Transformer Decoder** (4å±‚):
   - äº¤å‰æ³¨æ„åŠ›ï¼ˆæ— è‡ªæ³¨æ„åŠ›ï¼‰
   - ä½¿ç”¨ç¼ºå¤±åŒºå—çš„ä½ç½®ç¼–ç å¼•å¯¼ç”Ÿæˆ

7. **è¾“å‡ºå¤´**: é‡å»ºä¸ºåŸå§‹æ ·æœ¬æ ¼å¼ `(B, H, W, V)`

### å…³é”®ç‰¹æ€§

- **è‡ªå›å½’æ©ç **: æŒ‰æ©ç ç‡éšæœºæ©ç›–åç»­åŒºå—çš„æ³¨æ„åŠ›
- **æ—¶ç©ºå»ºæ¨¡**: åŒæ—¶å¤„ç†æ—¶é—´å’Œç©ºé—´ç»´åº¦
- **å¤šå˜é‡èåˆ**: æ”¯æŒå•å±‚å’Œå¤šå±‚æ°”è±¡å˜é‡
- **æ•°æ®å®Œæ•´æ€§**: è‡ªåŠ¨å¤„ç†ç¼ºå¤±æ•°æ®æ’å€¼

## ğŸ“Š è®­ç»ƒç›‘æ§

é¡¹ç›®é›†æˆäº†Wandbè¿›è¡Œå®éªŒè·Ÿè¸ªï¼š

- **æŸå¤±æ›²çº¿**: è®­ç»ƒ/éªŒè¯/æµ‹è¯•æŸå¤±
- **å­¦ä¹ ç‡è°ƒåº¦**: å®æ—¶ç›‘æ§å­¦ä¹ ç‡å˜åŒ–
- **å¯è§†åŒ–æ ·æœ¬**: å®šæœŸä¿å­˜é¢„æµ‹vsçœŸå®å€¼å¯¹æ¯”å›¾
- **æ¨¡å‹æ€§èƒ½**: å¤šç§è¯„ä¼°æŒ‡æ ‡è·Ÿè¸ª

## ğŸ”§ é…ç½®è¯´æ˜

### æ•°æ®é…ç½®

- `data_root`: æ•°æ®æ ¹ç›®å½•è·¯å¾„
- `time_interval`: é‡‡æ ·æ—¶é—´é—´éš”ï¼ˆ1=æ¯å°æ—¶ï¼Œ6=æ¯6å°æ—¶ï¼‰
- `variables`: ä½¿ç”¨çš„å˜é‡é…ç½®ï¼ˆæœ€å°‘9ä¸ªå˜é‡ï¼‰
- `years`: è®­ç»ƒ/éªŒè¯/æµ‹è¯•å¹´ä»½åˆ’åˆ†

### æ¨¡å‹é…ç½®

- `time_window`: æ—¶é—´çª—å£å¤§å°ï¼ˆé»˜è®¤8ï¼‰
- `patch_size`: patchå°ºå¯¸ï¼ˆé»˜è®¤16x16ï¼‰
- `embed_dim`: åµŒå…¥ç»´åº¦ï¼ˆé»˜è®¤768ï¼‰
- `random_patchify`: æ˜¯å¦éšæœºé€‰æ‹©ç¼ºå¤±åŒºå—
- `mask_ratio`: è‡ªå›å½’æ©ç æ¯”ä¾‹

### è®­ç»ƒé…ç½®

- `num_epochs`: è®­ç»ƒè½®æ•°
- `learning_rate`: å­¦ä¹ ç‡
- `optimizer`: ä¼˜åŒ–å™¨ç±»å‹ï¼ˆadam/adamw/sgdï¼‰
- `lr_scheduler`: å­¦ä¹ ç‡è°ƒåº¦ç­–ç•¥
- `early_stopping`: æ—©åœé…ç½®

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### å»ºè®®é…ç½®

**GPUå†…å­˜ä¼˜åŒ–:**
- è°ƒæ•´`batch_size`æ ¹æ®GPUå†…å­˜
- å¯ç”¨`mixed_precision`è®­ç»ƒ
- ä½¿ç”¨`num_workers`å¹¶è¡Œæ•°æ®åŠ è½½

**è®­ç»ƒæ•ˆç‡:**
- ä½¿ç”¨ä½™å¼¦å­¦ä¹ ç‡è°ƒåº¦
- è®¾ç½®åˆç†çš„`eval_every`é¢‘ç‡
- å¯ç”¨æ£€æŸ¥ç‚¹ä¿å­˜ç­–ç•¥

**æ¨¡å‹è°ƒä¼˜:**
- è°ƒæ•´`mask_ratio`å½±å“è®­ç»ƒéš¾åº¦
- ä¿®æ”¹`time_window`å¹³è¡¡ç²¾åº¦å’Œæ•ˆç‡
- ä¼˜åŒ–`patch_size`é€‚åº”æ•°æ®åˆ†è¾¨ç‡

## ğŸ› å¸¸è§é—®é¢˜

### Q: æ•°æ®åŠ è½½å¤±è´¥
**A**: æ£€æŸ¥æ•°æ®è·¯å¾„ã€æ–‡ä»¶æ ¼å¼å’Œmean_std.jsonæ–‡ä»¶æ˜¯å¦å­˜åœ¨

### Q: GPUå†…å­˜ä¸è¶³
**A**: å‡å°‘batch_sizeã€å¯ç”¨mixed_precisionæˆ–ä½¿ç”¨gradient_checkpointing

### Q: è®­ç»ƒæŸå¤±ä¸æ”¶æ•›
**A**: è°ƒæ•´å­¦ä¹ ç‡ã€æ£€æŸ¥æ•°æ®æ ‡å‡†åŒ–ã€å¢åŠ warmup epochs

### Q: é¢„æµ‹ç»“æœå¼‚å¸¸
**A**: æ£€æŸ¥æ¨¡å‹è¾“å…¥æ ¼å¼ã€ç¡®è®¤å½’ä¸€åŒ–/åå½’ä¸€åŒ–æ­£ç¡®

## ğŸ¤ è´¡çŒ®æŒ‡å—

1. Forké¡¹ç›®
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. å¼€å¯Pull Request

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨MITè®¸å¯è¯ - æŸ¥çœ‹ [LICENSE](LICENSE) æ–‡ä»¶äº†è§£è¯¦æƒ…

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»ï¼š

- é¡¹ç›®Issues: [GitHub Issues](https://github.com/Gdnaiteab/Ar_claude_test/issues)
- é‚®ç®±: [æ‚¨çš„é‚®ç®±]

## ğŸ™ è‡´è°¢

æ„Ÿè°¢ä»¥ä¸‹é¡¹ç›®å’Œè®ºæ–‡çš„å¯å‘ï¼š

- Vision Transformer (ViT)
- Transformeræ¶æ„
- æ°”è±¡æ•°æ®å¤„ç†ç›¸å…³ç ”ç©¶

---

**æ³¨æ„**: æœ¬é¡¹ç›®ä»…ç”¨äºç ”ç©¶å’Œå­¦ä¹ ç›®çš„ï¼Œè¯·ç¡®ä¿åœ¨ä½¿ç”¨å‰ç†è§£æ¨¡å‹çš„å±€é™æ€§å’Œé€‚ç”¨èŒƒå›´ã€‚